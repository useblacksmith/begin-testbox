name: 'Begin Testbox'
description: 'Initialize a Blacksmith Testbox session. Reads config from the VM metadata service, installs SSH key, rsync, and phones home with hydrating status.'

runs:
  using: 'composite'
  steps:
    - name: Discover metadata service
      id: metadata
      shell: bash
      run: |
        METADATA_PORT="${METADATA_PORT:-}"
        if [ -z "$METADATA_PORT" ]; then
          METADATA_PORT=$(cat /proc/cmdline | tr ' ' '\n' | grep '^metadata_port=' | cut -d'=' -f2)
          if [ -z "$METADATA_PORT" ]; then
            echo "metadata_port not found in kernel cmdline, testbox metadata not available"
            echo "available=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          export METADATA_PORT
        fi
        METADATA_ADDR="192.168.127.1:${METADATA_PORT}"

        TESTBOX_ID=$(curl -s --connect-timeout 2 --max-time 3 "http://${METADATA_ADDR}/testboxId" 2>/dev/null || true)
        if [ -z "$TESTBOX_ID" ] || [ "$TESTBOX_ID" = "unset" ]; then
          echo "No testbox metadata found on this VM"
          echo "available=false" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "available=true" >> "$GITHUB_OUTPUT"
        echo "metadata_addr=${METADATA_ADDR}" >> "$GITHUB_OUTPUT"

    - name: Read testbox config from metadata
      if: steps.metadata.outputs.available == 'true'
      shell: bash
      run: |
        METADATA_ADDR="${{ steps.metadata.outputs.metadata_addr }}"
        STATE=/tmp/.testbox
        mkdir -p "$STATE"
        chmod 700 "$STATE"

        curl -s --connect-timeout 2 --max-time 5 "http://${METADATA_ADDR}/testboxId" > "$STATE/testbox_id"
        curl -s --connect-timeout 2 --max-time 5 "http://${METADATA_ADDR}/testboxIdleTimeout" > "$STATE/idle_timeout"
        curl -s --connect-timeout 2 --max-time 5 "http://${METADATA_ADDR}/testboxSshPublicKey" > "$STATE/ssh_public_key"
        curl -s --connect-timeout 2 --max-time 5 "http://${METADATA_ADDR}/backendURL" > "$STATE/api_url"
        curl -s --connect-timeout 2 --max-time 5 "http://${METADATA_ADDR}/vmID" > "$STATE/vm_id"

        if [ -n "$BLACKSMITH_HOSTNAME" ]; then
          echo "$BLACKSMITH_HOSTNAME" > "$STATE/runner_host"
        else
          echo "$BLACKSMITH_HOST_PUBLIC_IP" > "$STATE/runner_host"
        fi
        echo "${BLACKSMITH_SSH_PORT:-22}" > "$STATE/runner_ssh_port"
        echo "$GITHUB_WORKSPACE" > "$STATE/working_directory"
        echo "$GITHUB_RUN_ID" > "$STATE/adopted_run_id"

        # Default idle_timeout if empty
        if [ ! -s "$STATE/idle_timeout" ]; then
          echo "10" > "$STATE/idle_timeout"
        fi

        echo "Testbox config loaded from metadata service: testbox_id=$(cat "$STATE/testbox_id")"

    - name: Install SSH public key
      if: steps.metadata.outputs.available == 'true'
      shell: bash
      run: |
        STATE=/tmp/.testbox
        SSH_PUBLIC_KEY=$(cat "$STATE/ssh_public_key")
        if [ -n "$SSH_PUBLIC_KEY" ]; then
          mkdir -p ~/.ssh
          echo "$SSH_PUBLIC_KEY" >> ~/.ssh/authorized_keys
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/authorized_keys
          echo "SSH public key installed"
        fi

    - name: Install rsync
      if: steps.metadata.outputs.available == 'true'
      shell: bash
      run: |
        which rsync || sudo apt-get install -y rsync

    - name: Phone home (hydrating)
      if: steps.metadata.outputs.available == 'true'
      shell: bash
      run: |
        STATE=/tmp/.testbox
        TESTBOX_ID=$(cat "$STATE/testbox_id")
        VM_ID=$(cat "$STATE/vm_id")
        API_URL=$(cat "$STATE/api_url")
        RUNNER_HOST=$(cat "$STATE/runner_host")
        RUNNER_SSH_PORT=$(cat "$STATE/runner_ssh_port")
        WORKING_DIRECTORY=$(cat "$STATE/working_directory")
        ADOPTED_RUN_ID=$(cat "$STATE/adopted_run_id")

        curl -s -f -X POST "${API_URL}/api/testbox/phone-home" \
          -H "Content-Type: application/json" \
          -d "{
            \"testbox_id\": \"${TESTBOX_ID}\",
            \"status\": \"hydrating\",
            \"vm_id\": \"${VM_ID}\",
            \"ip_address\": \"${RUNNER_HOST}\",
            \"ssh_port\": \"${RUNNER_SSH_PORT}\",
            \"working_directory\": \"${WORKING_DIRECTORY}\",
            \"adopted_run_id\": \"${ADOPTED_RUN_ID}\",
            \"metadata\": {}
          }" || echo "Warning: phone-home (hydrating) failed, continuing in degraded mode"
        echo "Phone-home (hydrating) complete."
